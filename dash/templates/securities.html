{% extends "base.html" %}

{% block title %}Securities{% endblock %}

{% block content %}
<main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">

    <div
        class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h2 class="mb-0">Securities</h2>
        <button type="button" class="btn btn-link" id="add-security-btn">+ Add New</button>
    </div>
    <div class="table-responsive small">
        <table class="table table-striped table-sm">
            <thead>
                <tr>
                    <th scope="col">#</th>
                    <th scope="col">Code</th>
                    <th scope="col">Exchange</th>
                    <th scope="col">Name</th>
                    <th scope="col">Type</th>
                    <th scope="col">Currency</th>
                    <th scope="col">Country</th>
                    <th scope="col">API</th>
                    <th scope="col">Action</th>
                </tr>
            </thead>
            <tbody>
                {% for security in securities %}
                <tr>
                    <td>{{ security.id }}</td>
                    <td>{{ security.code }}</td>
                    <td>{{ security.exchange }}</td>
                    <td>{{ security.name}}</td>
                    <td>{{ security.type}}</td>
                    <td>{{ security.currency}}</td>
                    <td>{{ security.country }}</td>
                    <td>{{ security.api_source}}</td>
                    <td>
                        <button class="btn btn-sm btn-link text-danger btn-delete-security" data-id="{{ security.id }}">Delete</button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="9" class="text-center">No security found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <!-- Pagination for transactions -->
    <nav>
        <ul class="pagination pagination-sm justify-content-center">
            {% if securities.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?txn_page={{ securities.previous_page_number }}">Previous</a>
            </li>
            {% else %}
            <li class="page-item disabled"><span class="page-link">Previous</span></li>
            {% endif %}

            {% for num in securities.paginator.page_range %}
            <li class="page-item {% if securities.number == num %}active{% endif %}">
                <a class="page-link" href="?page={{ num }}">{{ num }}</a>
            </li>
            {% endfor %}

            {% if securities.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ securities.next_page_number }}">Next</a>
            </li>
            {% else %}
            <li class="page-item disabled"><span class="page-link">Next</span></li>
            {% endif %}
        </ul>
    </nav>
</main>

<div id="modal-container"></div>
{% endblock %}


{% block page_scripts %}
<script>
    function getCSRFToken() {
        const match = document.cookie.match(/csrftoken=([^;]+)/);
        return match ? match[1] : '';
    }
    $('.btn-delete-security').click(function () {
        const id = $(this).data('id');

        if (confirm('Are you sure you want to delete this security?')) {
            fetch(`/api/security/${id}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': getCSRFToken()
                }
            })
                .then(res => {
                    if (res.ok) {
                        location.reload(); // hoặc remove row khỏi DOM nếu muốn fancy
                    } else {
                        alert('Failed to delete transaction.');
                    }
                })
                .catch(() => alert('Request failed.'));
        }
    });


    $('#add-security-btn').on('click', function () {
        $.get('/security/search/', function (data) {
            $('#modal-container').html(data);
            var modalEl = document.getElementById('tickerSearchModal');
            var modal = new bootstrap.Modal(modalEl);
            modal.show();

        });
    });

    $(document).on('keydown', '#search-ticker', function (e) {
        if (e.key === 'Enter' || e.keyCode === 13) {
            e.preventDefault();
            const query = $(this).val().trim();
            if (query.length < 2) {
                $('#securities-table-body').empty();
                return;
            }

            $.ajax({
                url: `/api/security/search/`,
                method: 'GET',
                data: { q: query },
                success: function (data) {
                    const tbody = $('#securities-table-body');
                    tbody.empty();

                    const yahoo = data.yahoo || [];
                    const eodhd = data.eodhd || [];

                    if (Array.isArray(yahoo)) {
                        yahoo.forEach((item, i) => {
                            const code = item.symbol || '';
                            const exchange = item.exchange || '';
                            const name = item.shortname || item.longname || '';
                            const type = item.quoteType || '';
                            const currency = item.currency || '';
                            const country = item.country || '';
                            tbody.append(`
                            <tr>
                              <td>${i + 1}</td>
                              <td>${code}</td>
                              <td>${exchange}</td>
                              <td>${name}</td>
                              <td>${type}</td>
                              <td>${currency}</td>
                              <td>${country}</td>
                              <td>yahoo</td>
                              <td><button class="btn btn-sm btn-link btn-add_security" data-api="yahoo">Add</button></td>
                            </tr>
                        `);
                        });
                    }

                    if (Array.isArray(eodhd)) {
                        eodhd.forEach((item, j) => {
                            const code = item.Code || '';
                            const exchange = item.Exchange || '';
                            const name = item.Name || '';
                            const type = item.Type || '';
                            const currency = item.Currency || '';
                            const country = item.Country || '';
                            tbody.append(`
                            <tr>
                              <td>${yahoo.length + j + 1}</td>
                              <td>${code}</td>
                              <td>${exchange}</td>
                              <td>${name}</td>
                              <td>${type}</td>
                              <td>${currency}</td>
                              <td>${country}</td>
                              <td>eodhd</td>
                              <td><button class="btn btn-sm btn-link btn-add_security"  data-api="eodhd">Add</button></td>
                            </tr>
                        `);
                        });
                    }

                    if (!yahoo.length && !eodhd.length) {
                        tbody.append('<tr><td colspan="8" class="text-center">No results found</td></tr>');
                    }
                },
                error: function () {
                    $('#securities-table-body').html('<tr><td colspan="8" class="text-center text-danger">Error loading data</td></tr>');
                }
            });
        }
    });

    $(document).on('click', '.btn-add_security', function () {
        const row = $(this).closest('tr');
        const code = row.find('td').eq(1).text();
        const exchange = row.find('td').eq(2).text();
        const name = row.find('td').eq(3).text();
        const type = row.find('td').eq(4).text();
        const currency = row.find('td').eq(5).text();
        const country = row.find('td').eq(6).text();
        const api_source = $(this).data('api') || 'unknown';
        $.ajax({
            url: '/api/security/add/',
            method: 'POST',
            data: {
                code,
                exchange,
                name,
                type,
                currency,
                country,
                api_source,  // hardcoded hoặc sau này chỉnh động
                csrfmiddlewaretoken: '{{ csrf_token }}',
            },
            success: function (res) {
                alert(res.status === 'ok' ? 'Added!' : 'Already exists.');
            },
            error: function () {
                alert('Error adding security');
            }
        });
    });
    $(document).on('click', '.close-search-btn', function () {
        location.reload()
    });

</script>
{% endblock %}