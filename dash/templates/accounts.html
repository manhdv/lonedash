{% extends "base.html" %}

{% block title %}Accounts{% endblock %}

{% block content %}

<main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
  <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h2 class="mb-0">Accounts</h2>
    <button type="button" class="btn btn-link" id="btn-add-account">
      + Add New
    </button>
  </div>
  <div class="table-responsive small">
    <table class="table table-striped table-sm">
      <thead>
        <tr>
          <th scope="col">#</th>
          <th scope="col">Name</th>
          <th scope="col">Type</th>
          <th scope="col">Balance</th>
          <th scope="col">Fee</th>
          <th scope="col">Tax</th>
          <th scope="col">Currency</th>
          <th scope="col">Action</th>
        </tr>
      </thead>
      <tbody>
        {% for account in accounts %}
        <tr>
          <td>{{ forloop.counter }}</td>
          <td>{{ account.name }}</td>
          <td>{{ account.get_type_display }}</td>
          <td>{{ account.last_balance }}</td>
          <td>{{ account.last_fee }}</td>
          <td>{{ account.last_tax }}</td>
          <td>{{ account.currency }}</td>
          <td>
            <button class="btn btn-sm btn-link btn-edit_account" data-id="{{ account.id }}">Edit</button>
            <button class="btn btn-sm btn-link text-danger btn-delete_account"
              data-id="{{ account.id }}">Delete</button>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="8" class="text-center">No accounts found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <nav>
    <ul class="pagination pagination-sm justify-content-center">
      {% if accounts.has_previous %}
      <li class="page-item">
        <a class="page-link" href="?page={{ accounts.previous_page_number }}">Previous</a>
      </li>
      {% else %}
      <li class="page-item disabled">
        <span class="page-link">Previous</span>
      </li>
      {% endif %}

      {% for num in accounts.paginator.page_range %}
      <li class="page-item {% if accounts.number == num %}active{% endif %}">
        <a class="page-link" href="?page={{ num }}">{{ num }}</a>
      </li>
      {% endfor %}

      {% if accounts.has_next %}
      <li class="page-item">
        <a class="page-link" href="?page={{ accounts.next_page_number }}">Next</a>
      </li>
      {% else %}
      <li class="page-item disabled">
        <span class="page-link">Next</span>
      </li>
      {% endif %}
    </ul>
  </nav>

  <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h2 class="mb-0">Transactions</h2>
    <button type="button" class="btn btn-link" id="add-transaction-btn">
      + Add Transaction
    </button>
  </div>
  <div class="table-responsive small">
    <table class="table table-striped table-sm">
      <thead>
        <tr>
          <th scope="col">#</th>
          <th scope="col">Date</th>
          <th scope="col">Type</th>
          <th scope="col">Amount</th>
          <th scope="col">Fee</th>
          <th scope="col">Tax</th>
          <th scope="col">Account</th>
          <th scope="col">Action</th>
        </tr>
      </thead>
      <tbody>
        {% for transaction in transactions %}
        <tr>
          <td>{{ transaction.id }}</td>
          <td>{{ transaction.date }}</td>
          <td>{{ transaction.get_type_display }}</td>
          <td>{{ transaction.amount}}</td>
          <td>{{ transaction.fee}}</td>
          <td>{{ transaction.tax}}</td>
          <td>{{ transaction.account }}</td>
          <td>
            <button class="btn btn-sm btn-link btn-edit-transaction" data-id="{{ transaction.id }} "
              data-csrf-token="{{ csrf_token }}">Edit</button>
            <button class="btn btn-sm btn-link text-danger btn-delete-transaction" data-id="{{ transaction.id }}"
              data-csrf-token="{{ csrf_token }}">Delete</button>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="8" class="text-center">No transaction found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <!-- Pagination for transactions -->
  <nav>
    <ul class="pagination pagination-sm justify-content-center">
      {% if transactions.has_previous %}
      <li class="page-item">
        <a class="page-link" href="?txn_page={{ transactions.previous_page_number }}">Previous</a>
      </li>
      {% else %}
      <li class="page-item disabled"><span class="page-link">Previous</span></li>
      {% endif %}

      {% for num in transactions.paginator.page_range %}
      <li class="page-item {% if transactions.number == num %}active{% endif %}">
        <a class="page-link" href="?txn_page={{ num }}">{{ num }}</a>
      </li>
      {% endfor %}

      {% if transactions.has_next %}
      <li class="page-item">
        <a class="page-link" href="?txn_page={{ transactions.next_page_number }}">Next</a>
      </li>
      {% else %}
      <li class="page-item disabled"><span class="page-link">Next</span></li>
      {% endif %}
    </ul>
  </nav>
</main>

<div id="modal-container"></div>
{% endblock %}

{% block page_scripts %}
<script>
  function getCSRFToken() {
    const match = document.cookie.match(/csrftoken=([^;]+)/);
    return match ? match[1] : '';
  }

  $('.btn-delete-transaction').click(function () {
    const txId = $(this).data('id');

    if (confirm('Are you sure you want to delete this transaction?')) {
      fetch(`/api/transaction/${txId}/`, {
        method: 'DELETE',
        headers: {
          'X-CSRFToken': getCSRFToken()
        }
      })
        .then(res => {
          if (res.ok) {
            location.reload(); // hoặc remove row khỏi DOM nếu muốn fancy
          } else {
            alert('Failed to delete transaction.');
          }
        })
        .catch(() => alert('Request failed.'));
    }
  });


  $('#add-transaction-btn').on('click', function () {
    $.get('/transaction/create/', function (data) {
      $('#modal-container').html(data);
      var modalEl = document.getElementById('addTransactionModal');
      var modal = new bootstrap.Modal(modalEl);
      modal.show();
    });
  });

  $('.btn-edit-transaction').on('click', function () {
    const txId = $(this).data('id');

    fetch(`/transaction/edit/${txId}`)
      .then(res => {
        if (!res.ok) throw new Error('Failed to load form');
        return res.text();
      })
      .then(html => {
        $('#modal-container').html(html);
        const modalEl = document.getElementById('addTransactionModal');
        const modal = new bootstrap.Modal(modalEl);
        modal.show();
      })
      .catch(err => {
        alert('Could not load transaction form.');
        console.error(err);
      });
  });


  $(document).on('submit', '#transaction-form', function (e) {
    e.preventDefault();

    const form = $(this);  // cần gán form ở đây
    const url = form.attr('action');  // lấy url từ form action

    const formData = new FormData(form[0]);
    const jsonData = {};
    formData.forEach((value, key) => { jsonData[key] = value; });
    // method nên dựa trên url:
    // nếu url chứa id thì PUT, không thì POST
    const method = url.match(/\/\d+\/?$/) ? 'PUT' : 'POST';

    fetch(url, {
      method: method,
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken(),
      },
      body: JSON.stringify(jsonData)
    })
      .then(res => {
        if (res.ok) return res.json();
        return res.json().then(data => Promise.reject(data));
      })
      .then(data => {
        $('#addTransactionModal').modal('hide');
        location.reload();
      })
      .catch(data => {
        if (data.errors) {
          for (let field in data.errors) {
            const input = $(`#id_transaction_${field}`);
            const errorHtml = `<div class="field-error text-danger small mt-1">${data.errors[field].join(', ')}</div>`;
            input.after(errorHtml);
          }
        } else {
          alert('Error updating transaction');
        }
      });
  });



  $('.btn-delete_account').click(function () {
    const accId = $(this).data('id');

    if (confirm('Are you sure you want to delete this account?')) {
      fetch(`/api/account/${accId}/`, {
        method: 'DELETE',
        headers: {
          'X-CSRFToken': getCSRFToken()
        }
      })
        .then(res => {
          if (res.ok) {
            location.reload(); // hoặc remove row khỏi DOM nếu muốn fancy
          } else {
            alert('Failed to delete account.');
          }
        })
        .catch(() => alert('Request failed.'));
    }
  });



  
  $('#btn-add-account').on('click', function () {
    $.get('/account/create', function (data) {
      $('#modal-container').html(data);
      var modalEl = document.getElementById('addAccountModal');
      var modal = new bootstrap.Modal(modalEl);
      modal.show();
    });
  });

    $('.btn-edit_account').on('click', function () {
    const accId = $(this).data('id');

    fetch(`/account/edit/${accId}`)
      .then(res => {
        if (!res.ok) throw new Error('Failed to load form');
        return res.text();
      })
      .then(html => {
        $('#modal-container').html(html);
        const modalEl = document.getElementById('addAccountModal');
        const modal = new bootstrap.Modal(modalEl);
        modal.show();
      })
      .catch(err => {
        alert('Could not load account form.');
        console.error(err);
      });
  });

  $(document).on('submit', '#account-form', function (e) {
    e.preventDefault();

    const form = $(this);  // cần gán form ở đây
    const url = form.attr('action');  // lấy url từ form action

    const formData = new FormData(form[0]);
    const jsonData = {};
    formData.forEach((value, key) => { jsonData[key] = value; });
    // method nên dựa trên url:
    // nếu url chứa id thì PUT, không thì POST
    const method = url.match(/\/\d+\/?$/) ? 'PUT' : 'POST';

    fetch(url, {
      method: method,
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken(),
      },
      body: JSON.stringify(jsonData)
    })
      .then(res => {
        if (res.ok) return res.json();
        return res.json().then(data => Promise.reject(data));
      })
      .then(data => {
        $('#addAccountModal').modal('hide');
        location.reload();
      })
      .catch(data => {
        if (data.errors) {
          for (let field in data.errors) {
            const input = $(`#id_account_${field}`);
            const errorHtml = `<div class="field-error text-danger small mt-1">${data.errors[field].join(', ')}</div>`;
            input.after(errorHtml);
          }
        } else {
          alert('Error updating account');
        }
      });
  });



</script>
{% endblock %}