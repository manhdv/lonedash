{% extends "base.html" %}

{% block title %}Accounts{% endblock %}

{% block content %}

<main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">Accounts</h2>
    <button type="button" class="btn btn-sm btn-link" id = "add-account-btn">
      + Add New
    </button>
  </div>
  <div class="table-responsive small">
    <table class="table table-striped table-sm">
      <thead>
        <tr>
          <th scope="col">#</th>
          <th scope="col">Name</th>
          <th scope="col">Type</th>
          <th scope="col">Balance</th>
          <th scope="col">Fee</th>
          <th scope="col">Tax</th>
          <th scope="col">Currency</th>
          <th scope="col">Action</th>
        </tr>
      </thead>
      <tbody>
        {% for account in accounts %}
        <tr>
          <td>{{ forloop.counter }}</td>
          <td>{{ account.name }}</td>
          <td>{{ account.get_type_display }}</td>
          <td>{{ account.last_balance }}</td>
          <td>{{ account.last_fee }}</td>
          <td>{{ account.last_tax }}</td>
          <td>{{ account.currency }}</td>
          <td>
            <button class="btn btn-sm btn-link edit_account-btn" data-id="{{ account.id }}">Edit</button>
            <button class="btn btn-sm btn-link text-danger delete-account-btn" data-id="{{ account.id }}">Delete</button>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="5" class="text-center">No accounts found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <nav>
    <ul class="pagination pagination-sm justify-content-center">
      {% if accounts.has_previous %}
      <li class="page-item">
        <a class="page-link" href="?page={{ accounts.previous_page_number }}">Previous</a>
      </li>
      {% else %}
      <li class="page-item disabled">
        <span class="page-link">Previous</span>
      </li>
      {% endif %}

      {% for num in accounts.paginator.page_range %}
      <li class="page-item {% if accounts.number == num %}active{% endif %}">
        <a class="page-link" href="?page={{ num }}">{{ num }}</a>
      </li>
      {% endfor %}

      {% if accounts.has_next %}
      <li class="page-item">
        <a class="page-link" href="?page={{ accounts.next_page_number }}">Next</a>
      </li>
      {% else %}
      <li class="page-item disabled">
        <span class="page-link">Next</span>
      </li>
      {% endif %}
    </ul>
  </nav>

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">Transactions</h2>
    <button type="button" class="btn btn-sm btn-link" id="add-transaction-btn">
      + Add Transaction
    </button>
  </div>
  <div class="table-responsive small">
    <table class="table table-striped table-sm">
      <thead>
        <tr>
          <th scope="col">#</th>
          <th scope="col">Date</th>
          <th scope="col">Type</th>
          <th scope="col">Amount</th>
          <th scope="col">Fee</th>
          <th scope="col">Tax</th>
          <th scope="col">Account</th>
          <th scope="col">Action</th>
        </tr>
      </thead>
      <tbody>
        {% for transaction in transactions %}
        <tr>
          <td>{{ transaction.id }}</td>
          <td>{{ transaction.date }}</td>
          <td>{{ transaction.get_type_display }}</td>
          <td>{{ transaction.amount|floatformat:2 }}</td>
          <td>{{ transaction.fee|floatformat:2 }}</td>
          <td>{{ transaction.tax|floatformat:2 }}</td>
          <td>{{ transaction.account }}</td>
          <td>
            <button class="btn btn-sm btn-link edit-transaction-btn" data-id="{{ transaction.id }}">Edit</button>
            <button class="btn btn-sm btn-link text-danger delete-transaction-btn" data-id="{{ transaction.id }}">Delete</button>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="8" class="text-center">No transaction found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <!-- Pagination for transactions -->
  <nav>
    <ul class="pagination pagination-sm justify-content-center">
      {% if transactions.has_previous %}
      <li class="page-item">
        <a class="page-link" href="?txn_page={{ transactions.previous_page_number }}">Previous</a>
      </li>
      {% else %}
      <li class="page-item disabled"><span class="page-link">Previous</span></li>
      {% endif %}

      {% for num in transactions.paginator.page_range %}
      <li class="page-item {% if transactions.number == num %}active{% endif %}">
        <a class="page-link" href="?txn_page={{ num }}">{{ num }}</a>
      </li>
      {% endfor %}

      {% if transactions.has_next %}
      <li class="page-item">
        <a class="page-link" href="?txn_page={{ transactions.next_page_number }}">Next</a>
      </li>
      {% else %}
      <li class="page-item disabled"><span class="page-link">Next</span></li>
      {% endif %}
    </ul>
  </nav>
</main>

<!-- Modal -->
<form method="post" action="{% url 'transaction_delete' %}" id="deleteTransactionForm" style="display:none;">
  {% csrf_token %}
  <input type="hidden" name="transaction_id" id="deleteTransactionId">
</form>

<form method="post" action="{% url 'account_delete' %}" id="deleteAccountForm" style="display:none;">
  {% csrf_token %}
  <input type="hidden" name="account_id" id="deleteAccountId">
</form>

<div id="modal-container"></div>
{% endblock %}

{% block page_scripts %}
<script>
$('.delete-transaction-btn').click(function() {
  const txId = $(this).data('id');
  if (confirm('Are you sure you want to delete this transaction?')) {
    $('#deleteTransactionId').val(txId);
    $('#deleteTransactionForm').submit();
  }
});


  $('#add-transaction-btn').on('click', function(){
    $.get('/transaction/new', function(data){
      $('#modal-container').html(data);
      var modalEl = document.getElementById('addTransactionModal');
      var modal = new bootstrap.Modal(modalEl);
      modal.show();
    });
  });

  $('.edit-transaction-btn').on('click', function() {
  const accId = $(this).data('id');
  $.get(`/transaction/edit/${accId}`, function(data) {
    $('#modal-container').html(data);
    const modalEl = document.getElementById('addTransactionModal');
    const modal = new bootstrap.Modal(modalEl);
    modal.show();
  });
});


$(document).on('submit', '#transaction-form', function(e) {
  e.preventDefault();
  const form = $(this);
  const formData = form.serialize();

  // Xoá lỗi cũ
  // $('.field-error').remove();

  $.ajax({
    type: 'POST',
    url: form.attr('action'),  // hoặc hardcode URL cũng được
    data: formData,
    success: function(response) {
      $('#addTransactionModal').modal('hide');
      location.reload();
    },
    error: function(xhr) {
      const errors = xhr.responseJSON.errors;

      for (let field in errors) {
        const input = $(`#id_transaction_${field}`);
        const errorHtml = `<div class="field-error text-danger small mt-1">${errors[field].join(', ')}</div>`;
        input.after(errorHtml);
      }
    }
  });
});


$('.delete-account-btn').click(function() {
  const txId = $(this).data('id');
  if (confirm('Are you sure you want to delete this transaction?')) {
    $('#deleteAccountId').val(txId);
    $('#deleteAccountForm').submit();
  }
});


  $('#add-account-btn').on('click', function(){
    $.get('/account/new', function(data){
      $('#modal-container').html(data);
      var modalEl = document.getElementById('addAccountModal');
      var modal = new bootstrap.Modal(modalEl);
      modal.show();
    });
  });

  $('.edit_account-btn').on('click', function() {
  const txId = $(this).data('id');
  $.get(`/account/edit/${txId}`, function(data) {
    $('#modal-container').html(data);
    const modalEl = document.getElementById('addAccountModal');
    const modal = new bootstrap.Modal(modalEl);
    modal.show();
  });
});

$(document).on('submit', '#account-form', function(e) {
  e.preventDefault();
  const form = $(this);
  const formData = form.serialize();

  // Xoá lỗi cũ
  // $('.field-error').remove();

  $.ajax({
    type: 'POST',
    url: form.attr('action'),  // hoặc hardcode URL cũng được
    data: formData,
    success: function(response) {
      $('#addAccountModal').modal('hide');
      location.reload();
    },
    error: function(xhr) {
      const errors = xhr.responseJSON.errors;

      for (let field in errors) {
        const input = $(`#id_account_${field}`);
        const errorHtml = `<div class="field-error text-danger small mt-1">${errors[field].join(', ')}</div>`;
        input.after(errorHtml);
      }
    }
  });
});
</script>
{% endblock %}